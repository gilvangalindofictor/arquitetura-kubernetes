# =============================================================================
# Network Policy: Allow Monitoring Ingress (Monitoring Namespace)
# =============================================================================
# Permite ingress nas portas de m√©tricas dos pods de monitoring
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-metrics-ingress
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    # Allow Prometheus to scrape metrics from all pods in monitoring namespace
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 9100  # node-exporter
        - protocol: TCP
          port: 8080  # kube-state-metrics
        - protocol: TCP
          port: 9090  # prometheus
        - protocol: TCP
          port: 3100  # loki
        - protocol: TCP
          port: 9093  # alertmanager
    # Allow Grafana to access Prometheus and Loki
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - protocol: TCP
          port: 9090  # prometheus
        - protocol: TCP
          port: 80    # loki-gateway
        - protocol: TCP
          port: 3100  # loki
    # Allow Fluent Bit to send logs to Loki
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: fluent-bit
      ports:
        - protocol: TCP
          port: 80    # loki-gateway
        - protocol: TCP
          port: 3100  # loki direct
    # Allow Loki internal communication (memberlist)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: loki
      ports:
        - protocol: TCP
          port: 7946  # memberlist
        - protocol: TCP
          port: 3100  # loki internal
        - protocol: TCP
          port: 9095  # loki grpc
